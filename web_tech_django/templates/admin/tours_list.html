{% extends 'admin/base_admin.html' %}

{% block title %}User Analytics Dashboard{% endblock %}

{% block content %}
<div class="container">
    <h1 class="my-4 text-center">Tour Data Analytics Dashboard</h1>

    <!-- Table Section -->
    <div class="card">
        <div class="card-header">
            Tours
        </div>
        <div class="card-body">
            <table class="table table-hover table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Started date</th>
                        <th scope="col">Duration</th>
                        <th scope="col">Price</th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                {% if tours %}
                    {% for tour in page_obj %}
                    <tr>
                        <th scope="row">{{ tour.id }}</th>
                        <td>{{ tour.name }}</td>
                        <td>{{ tour.started }}</td>
                        <td>{{ tour.duration }} days</td>
                        <td>{{ tour.price }}</td>
                        <td><a href="{% url 'blog:tour_edit' id=tour.id %}" class="btn btn-primary">Edit</a></td>
                        <td><a href="{% url 'blog:tour_detail' id=tour.id %}" class="btn btn-outline-secondary">View</a></td>
                        <td><a href="{% url 'blog:tour_delete' id=tour.id %}" class="btn btn-danger">Delete</a></td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <div>Tours are not available!</div>
                {% endif %}
                </tbody>
            </table>
            <div class="pagination">
                <span class="step-links">
                    {% if page_obj.has_previous %}
                        <a href="?page=1">&laquo; first</a>
                        <a href="?page={{ page_obj.previous_page_number }}">previous</a>
                    {% endif %}
            
                    <span class="current">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                    </span>
            
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}">next</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    <div class="row mt-5">
        <h2 class="text-center w-100">Analytics</h2>
        <div class="col-md-6 my-3">
            <canvas id="pieChart"></canvas>
        </div>
        <div class="col-md-6 my-3">
            <canvas id="histogramChart"></canvas>
        </div>
        <div class="col-md-6 my-3">
            <canvas id="lineChartDuration"></canvas>
        </div>
        <div class="col-md-6 my-3">
            <canvas id="lineChartPrice"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
<script>
    const tableRows = document.querySelectorAll("table tbody tr");
    const labels = [];
    const durations = [];
    const prices = [];

    tableRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length > 0) {
            labels.push(cells[0].textContent.trim());
            durations.push(parseInt(cells[2].textContent.trim().split(" ")[0], 10)); // Duration
            prices.push(parseFloat(cells[3].textContent.trim()));
        }
    });
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tour Popularity',
                data: durations,
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4CAF50', '#FF5722']
            }]
        }
    });
    const histogramCtx = document.getElementById('histogramChart').getContext('2d');
    new Chart(histogramCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tour Prices',
                data: prices,
                backgroundColor: '#36A2EB'
            }]
        }
    });
    const lineDurationCtx = document.getElementById('lineChartDuration').getContext('2d');
    new Chart(lineDurationCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tour Duration (days)',
                data: durations,
                borderColor: '#FF5722',
                fill: false
            }]
        }
    });
    const linePriceCtx = document.getElementById('lineChartPrice').getContext('2d');
    new Chart(linePriceCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Tour Prices',
                data: prices,
                borderColor: '#36A2EB',
                fill: false
            }]
        }
    });
</script>
{% endblock %}
